<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§å›¾åƒåƒç´ æŸ¥çœ‹å·¥å…· - å…¨é¢æ”¯æŒPGM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50, #1a2a6c);
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 1400px;
            width: 100%;
            background: rgba(25, 35, 65, 0.95);
            border-radius: 15px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid #3498db;
        }
        
        header {
            text-align: center;
            padding: 25px 20px;
            background: rgba(15, 25, 55, 0.95);
            border-bottom: 2px solid #3498db;
            position: relative;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #3498db, #2ecc71, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            color: #bdc3c7;
            font-size: 1.15rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.7;
        }
        
        .format-badges {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .format-badge {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 0.9rem;
            color: #3498db;
            font-weight: 600;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 320px;
            background: rgba(20, 30, 60, 0.7);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid #2980b9;
        }
        
        .panel-section {
            background: rgba(15, 25, 55, 0.6);
            border-radius: 10px;
            padding: 18px;
            border: 1px solid #1abc9c;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 16px;
            color: #1abc9c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.5rem;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        button {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: linear-gradient(to right, #3ca0db, #2c8bc9);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.reset {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }
        
        button.reset:hover {
            background: linear-gradient(to right, #ec7063, #d35400);
        }
        
        button.grid {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
        }
        
        button.grid:hover {
            background: linear-gradient(to right, #af7ac5, #9b59b6);
        }
        
        .info-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .info-item {
            background: rgba(25, 45, 85, 0.6);
            padding: 14px;
            border-radius: 8px;
            font-size: 0.95rem;
            border: 1px solid #34495e;
        }
        
        .info-label {
            color: #1abc9c;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .info-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3498db;
            word-break: break-all;
        }
        
        .canvas-container {
            flex: 2;
            min-width: 500px;
            position: relative;
            background: #0c1424;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            height: 650px;
            border: 1px solid #2c3e50;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        
        .grid-canvas {
            pointer-events: none;
            z-index: 10;
        }
        
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #3498db;
        }
        
        .instructions {
            margin: 20px;
            padding: 20px;
            background: rgba(15, 25, 55, 0.7);
            border-radius: 12px;
            border-left: 4px solid #1abc9c;
        }
        
        .instructions h3 {
            color: #1abc9c;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .instructions ul {
            padding-left: 25px;
            margin-bottom: 15px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .instructions code {
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: #f39c12;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feature {
            background: rgba(44, 62, 80, 0.5);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #3498db;
        }
        
        .pgm-instructions {
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid #9b59b6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .pgm-instructions h4 {
            color: #9b59b6;
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            padding: 25px 20px;
            color: #7f8c8d;
            font-size: 0.95rem;
            margin-top: 20px;
            border-top: 1px solid #34495e;
            width: 100%;
        }
        
        .zoom-indicator {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 20;
            border: 1px solid #3498db;
        }
        
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #7f8c8d;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
        }
        
        .error-message {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .success-message {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .download-sample {
            margin-top: 10px;
            display: inline-block;
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
        }
        
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            
            .canvas-container {
                height: 500px;
                min-width: 100%;
            }
            
            h1 {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>é«˜çº§å›¾åƒåƒç´ æŸ¥çœ‹å·¥å…·</h1>
            <p class="subtitle">å…¨é¢æ”¯æŒæ‰€æœ‰ä¸»æµå›¾åƒæ ¼å¼(BMP, JPG, JPEG, PNG, PGMç­‰)ï¼Œå¯æ”¾å¤§è‡³å•ä¸ªåƒç´ çº§åˆ«ï¼Œå®æ—¶æ˜¾ç¤ºåƒç´ åæ ‡ã€RGBå€¼å’Œå°ºå¯¸ä¿¡æ¯</p>
            <div class="format-badges">
                <div class="format-badge">BMP</div>
                <div class="format-badge">JPG</div>
                <div class="format-badge">JPEG</div>
                <div class="format-badge">PNG</div>
                <div class="format-badge">PGM</div>
                <div class="format-badge">GIF</div>
                <div class="format-badge">WEBP</div>
                <div class="format-badge">TIFF</div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <div class="panel-section">
                    <h2 class="section-title">ğŸ“ å›¾åƒå¯¼å…¥</h2>
                    <div class="btn-group">
                        <button id="uploadBtn">
                            <span>ä¸Šä¼ å›¾åƒ</span>
                        </button>
                        <button id="sampleBtn">
                            <span>ä½¿ç”¨ç¤ºä¾‹å›¾åƒ</span>
                        </button>
                        <button id="pgmSampleBtn">
                            <span>ä¸‹è½½PGMç¤ºä¾‹</span>
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept="image/*,.pgm" style="display: none;">
                    
                    <div id="errorMessage" class="error-message"></div>
                    <div id="successMessage" class="success-message"></div>
                    
                    <div class="pgm-instructions">
                        <h4>PGMæ–‡ä»¶ä¸Šä¼ è¯´æ˜</h4>
                        <p>æœ¬å·¥å…·æ”¯æŒä¸¤ç§PGMæ ¼å¼ï¼š</p>
                        <ul>
                            <li><strong>P2 (ASCIIæ ¼å¼)</strong> - æ–‡æœ¬å¯è¯»çš„PGMæ–‡ä»¶</li>
                            <li><strong>P5 (äºŒè¿›åˆ¶æ ¼å¼)</strong> - äºŒè¿›åˆ¶PGMæ–‡ä»¶</li>
                        </ul>
                        <p>å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½ç¤ºä¾‹PGMæ–‡ä»¶æµ‹è¯•ã€‚</p>
                        <a href="#" id="downloadSample" class="download-sample">ä¸‹è½½ç¤ºä¾‹PGMæ–‡ä»¶</a>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h2 class="section-title">ğŸ” åƒç´ ä¿¡æ¯</h2>
                    <div class="info-display">
                        <div class="info-item">
                            <div class="info-label">åæ ‡</div>
                            <div id="coordValue" class="info-value">(0, 0)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">RGB å€¼</div>
                            <div id="rgbValue" class="info-value">(0, 0, 0)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">åƒç´ å¤§å°</div>
                            <div id="pixelSizeValue" class="info-value">1Ã—1 px</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç¼©æ”¾æ¯”ä¾‹</div>
                            <div id="zoomValue" class="info-value">100%</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å›¾åƒå°ºå¯¸</div>
                            <div id="sizeValue" class="info-value">0 Ã— 0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">æ–‡ä»¶æ ¼å¼</div>
                            <div id="formatValue" class="info-value">-</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <span>é¢œè‰²é¢„è§ˆ:</span>
                        <div id="colorPreview" class="color-preview" style="background: #000;"></div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h2 class="section-title">âš™ï¸ è§†å›¾æ§åˆ¶</h2>
                    <div class="btn-group">
                        <button id="zoomInBtn">
                            <span>æ”¾å¤§ +</span>
                        </button>
                        <button id="zoomOutBtn">
                            <span>ç¼©å° -</span>
                        </button>
                        <button id="resetViewBtn" class="reset">
                            <span>é‡ç½®è§†å›¾</span>
                        </button>
                        <button id="toggleGridBtn" class="grid">
                            <span>ç½‘æ ¼: å¼€</span>
                        </button>
                    </div>
                    <p style="margin-top: 15px; color: #bdc3c7; font-size: 0.95rem;">
                        æç¤ºï¼šä½¿ç”¨é¼ æ ‡æ»šè½®ç¼©æ”¾ï¼ŒæŒ‰ä½å·¦é”®æ‹–åŠ¨å¹³ç§»<br>
                        æœ€å¤§æ”¾å¤§å€æ•°: 1600%
                    </p>
                </div>
            </div>
            
            <div class="canvas-container">
                <canvas id="mainCanvas"></canvas>
                <canvas id="gridCanvas" class="grid-canvas"></canvas>
                <div class="zoom-indicator">ç¼©æ”¾: <span id="zoomIndicator">100%</span></div>
                <div class="status-bar">
                    <div>çŠ¶æ€: <span id="statusText">å°±ç»ª</span></div>
                    <div>åƒç´ ç½‘æ ¼: <span id="gridStatus">å¼€å¯</span></div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>å¯¼å…¥å›¾åƒ</strong> - ç‚¹å‡»"ä¸Šä¼ å›¾åƒ"æŒ‰é’®é€‰æ‹©æœ¬åœ°å›¾ç‰‡ï¼Œæˆ–ä½¿ç”¨"ä½¿ç”¨ç¤ºä¾‹å›¾åƒ"</li>
                <li><strong>PGMæ–‡ä»¶</strong> - æ”¯æŒP2(ASCII)å’ŒP5(äºŒè¿›åˆ¶)æ ¼å¼ï¼Œç‚¹å‡»"ä¸‹è½½PGMç¤ºä¾‹"è·å–æµ‹è¯•æ–‡ä»¶</li>
                <li><strong>æŸ¥çœ‹åƒç´ ä¿¡æ¯</strong> - åœ¨å›¾åƒä¸Šç§»åŠ¨é¼ æ ‡ï¼Œå®æ—¶æ˜¾ç¤ºåæ ‡ã€RGBå€¼å’Œåƒç´ å¤§å°</li>
                <li><strong>å¹³ç§»è§†å›¾</strong> - æŒ‰ä½é¼ æ ‡å·¦é”®å¹¶æ‹–åŠ¨å›¾åƒ</li>
                <li><strong>ç¼©æ”¾è§†å›¾</strong> - ä½¿ç”¨é¼ æ ‡æ»šè½®ï¼Œæˆ–ç‚¹å‡»æ”¾å¤§/ç¼©å°æŒ‰é’® (æœ€å¤§1600%)</li>
                <li><strong>ç½‘æ ¼æ˜¾ç¤º</strong> - ç‚¹å‡»"ç½‘æ ¼"æŒ‰é’®åˆ‡æ¢åƒç´ ç½‘æ ¼æ˜¾ç¤º</li>
                <li><strong>é‡ç½®è§†å›¾</strong> - ç‚¹å‡»"é‡ç½®è§†å›¾"æŒ‰é’®æ¢å¤åŸå§‹å¤§å°å’Œä½ç½®</li>
                <li><strong>å¿«æ·é”®</strong> - <code>+</code> æ”¾å¤§, <code>-</code> ç¼©å°, <code>0</code> é‡ç½®è§†å›¾, <code>G</code> åˆ‡æ¢ç½‘æ ¼</li>
            </ul>
            
            <div class="features">
                <div class="feature">
                    <strong>å…¨æ ¼å¼æ”¯æŒ</strong>: BMP, JPG, JPEG, PNG, PGM(P2/P5), GIF, WEBP, TIFF
                </div>
                <div class="feature">
                    <strong>åƒç´ çº§æ”¾å¤§</strong>: å¯æ”¾å¤§è‡³1600%ï¼Œæ¸…æ™°æŸ¥çœ‹æ¯ä¸ªåƒç´ 
                </div>
                <div class="feature">
                    <strong>å®æ—¶ä¿¡æ¯</strong>: åæ ‡ã€RGBå€¼ã€åƒç´ å¤§å°å®æ—¶æ˜¾ç¤º
                </div>
                <div class="feature">
                    <strong>ç½‘æ ¼è¾…åŠ©</strong>: å¯åˆ‡æ¢æ˜¾ç¤ºåƒç´ ç½‘æ ¼çº¿
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Â© 2023 é«˜çº§å›¾åƒåƒç´ æŸ¥çœ‹å·¥å…· | åŸºäºæµè§ˆå™¨çš„å•æ–‡ä»¶åº”ç”¨ | å…¨é¢æ”¯æŒPGMæ ¼å¼</p>
    </footer>

    <script>
        // è·å–DOMå…ƒç´ 
        const mainCanvas = document.getElementById('mainCanvas');
        const gridCanvas = document.getElementById('gridCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const gridCtx = gridCanvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const sampleBtn = document.getElementById('sampleBtn');
        const pgmSampleBtn = document.getElementById('pgmSampleBtn');
        const downloadSample = document.getElementById('downloadSample');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');
        const toggleGridBtn = document.getElementById('toggleGridBtn');
        const coordValue = document.getElementById('coordValue');
        const rgbValue = document.getElementById('rgbValue');
        const pixelSizeValue = document.getElementById('pixelSizeValue');
        const zoomValue = document.getElementById('zoomValue');
        const zoomIndicator = document.getElementById('zoomIndicator');
        const sizeValue = document.getElementById('sizeValue');
        const formatValue = document.getElementById('formatValue');
        const colorPreview = document.getElementById('colorPreview');
        const statusText = document.getElementById('statusText');
        const gridStatus = document.getElementById('gridStatus');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        
        // çŠ¶æ€å˜é‡
        let img = null;
        let scale = 1.0;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;
        let imgWidth = 0;
        let imgHeight = 0;
        let showGrid = true;
        let fileName = '';
        let fileType = '';
        
        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            const container = mainCanvas.parentElement;
            mainCanvas.width = container.clientWidth;
            mainCanvas.height = container.clientHeight;
            gridCanvas.width = container.clientWidth;
            gridCanvas.height = container.clientHeight;
            drawImage();
            drawGrid();
        }
        
        // ç»˜åˆ¶å›¾åƒ
        function drawImage() {
            mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            
            if (!img) {
                // ç»˜åˆ¶å ä½ç¬¦
                mainCtx.fillStyle = '#0c1424';
                mainCtx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
                
                mainCtx.strokeStyle = '#3498db';
                mainCtx.lineWidth = 2;
                mainCtx.setLineDash([5, 5]);
                mainCtx.strokeRect(mainCanvas.width/2 - 120, mainCanvas.height/2 - 90, 240, 180);
                mainCtx.setLineDash([]);
                
                mainCtx.font = '20px Arial';
                mainCtx.fillStyle = '#3498db';
                mainCtx.textAlign = 'center';
                mainCtx.fillText('è¯·ä¸Šä¼ å›¾åƒæˆ–ä½¿ç”¨ç¤ºä¾‹å›¾åƒ', mainCanvas.width/2, mainCanvas.height/2 - 20);
                
                mainCtx.font = '16px Arial';
                mainCtx.fillStyle = '#7f8c8d';
                mainCtx.fillText('æ”¯æŒæ ¼å¼: BMP, JPG, JPEG, PNG, PGMç­‰', mainCanvas.width/2, mainCanvas.height/2 + 20);
                return;
            }
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            mainCtx.save();
            
            // åº”ç”¨å¹³ç§»å’Œç¼©æ”¾
            mainCtx.translate(offsetX, offsetY);
            mainCtx.scale(scale, scale);
            
            // ç¦ç”¨å›¾åƒå¹³æ»‘ä»¥å®ç°åƒç´ çº§æ¸²æŸ“
            mainCtx.imageSmoothingEnabled = false;
            
            // ç»˜åˆ¶å›¾åƒ
            mainCtx.drawImage(img, 0, 0);
            
            // æ¢å¤çŠ¶æ€
            mainCtx.restore();
        }
        
        // ç»˜åˆ¶ç½‘æ ¼
        function drawGrid() {
            if (!showGrid || !img) {
                gridCtx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
                return;
            }
            
            gridCtx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
            gridCtx.strokeStyle = 'rgba(52, 152, 219, 0.3)';
            gridCtx.lineWidth = 1;
            
            // è®¡ç®—ç½‘æ ¼èµ·ç‚¹å’Œæ­¥é•¿
            const startX = Math.floor(-offsetX / scale) * scale + offsetX;
            const startY = Math.floor(-offsetY / scale) * scale + offsetY;
            const stepX = scale;
            const stepY = scale;
            
            // ç»˜åˆ¶å‚ç›´çº¿
            for (let x = startX; x < gridCanvas.width; x += stepX) {
                gridCtx.beginPath();
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, gridCanvas.height);
                gridCtx.stroke();
            }
            
            // ç»˜åˆ¶æ°´å¹³çº¿
            for (let y = startY; y < gridCanvas.height; y += stepY) {
                gridCtx.beginPath();
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(gridCanvas.width, y);
                gridCtx.stroke();
            }
        }
        
        // åŠ è½½å›¾åƒ
        function loadImage(src, name = '', type = '') {
            statusText.textContent = 'åŠ è½½å›¾åƒä¸­...';
            hideMessages();
            
            // å¦‚æœæ˜¯PGMæ–‡ä»¶ï¼Œä½¿ç”¨ç‰¹æ®Šå¤„ç†
            if (type === 'pgm' || (name && name.toLowerCase().endsWith('.pgm'))) {
                loadPGMImage(src, name);
                return;
            }
            
            img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                handleImageLoad(this, name, type);
            };
            img.onerror = function() {
                showError("æ— æ³•åŠ è½½å›¾åƒï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶");
                statusText.textContent = 'åŠ è½½å¤±è´¥';
            };
            img.src = src;
            fileName = name;
            fileType = type;
        }
        
        // åŠ è½½PGMå›¾åƒ - å¢å¼ºç‰ˆ
        function loadPGMImage(src, name) {
            statusText.textContent = 'è§£æPGMå›¾åƒ...';
            
            // ç¡®å®šæ–‡ä»¶ç±»å‹ï¼ˆP2æˆ–P5ï¼‰
            const isBinary = name.toLowerCase().endsWith('.p5.pgm') || 
                             (src instanceof ArrayBuffer && isP5Format(src));
            
            if (src instanceof File) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (isBinary) {
                        parseP5Format(e.target.result, name);
                    } else {
                        parseP2Format(e.target.result, name);
                    }
                };
                reader.readAsArrayBuffer(src);
            } else if (src instanceof ArrayBuffer) {
                if (isBinary) {
                    parseP5Format(src, name);
                } else {
                    parseP2Format(src, name);
                }
            } else {
                // å¦‚æœæ˜¯URLï¼Œéœ€è¦å…ˆè·å–å†…å®¹
                fetch(src)
                    .then(response => response.arrayBuffer())
                    .then(data => {
                        if (isBinary) {
                            parseP5Format(data, name);
                        } else {
                            parseP2Format(data, name);
                        }
                    })
                    .catch(error => {
                        showError("åŠ è½½PGMæ–‡ä»¶å¤±è´¥: " + error.message);
                        statusText.textContent = 'åŠ è½½å¤±è´¥';
                    });
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºP5æ ¼å¼
        function isP5Format(buffer) {
            if (buffer.byteLength < 2) return false;
            const header = new Uint8Array(buffer.slice(0, 2));
            return header[0] === 80 && header[1] === 53; // 'P' and '5'
        }
        
        // è§£æP2æ ¼å¼(PGM ASCII)
        function parseP2Format(data, name) {
            try {
                // å°†ArrayBufferè½¬æ¢ä¸ºæ–‡æœ¬
                const decoder = new TextDecoder('ascii');
                const content = decoder.decode(data);
                const lines = content.split(/[\r\n]+/);
                
                let width = 0;
                let height = 0;
                let maxVal = 255;
                let pixelData = [];
                let readingPixels = false;
                
                // è§£æå¤´éƒ¨
                for (let line of lines) {
                    line = line.trim();
                    
                    // è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
                    if (!line || line.startsWith('#')) continue;
                    
                    if (!readingPixels) {
                        if (line.startsWith('P2')) {
                            continue; // æ ¼å¼æ ‡è¯†
                        }
                        
                        const parts = line.split(/\s+/);
                        if (parts.length >= 2) {
                            if (width === 0) {
                                width = parseInt(parts[0]);
                                height = parseInt(parts[1]);
                            } else if (maxVal === 255) {
                                maxVal = parseInt(parts[0]);
                            }
                            
                            // å¦‚æœå·²è·å–æ‰€æœ‰å¤´éƒ¨ä¿¡æ¯ï¼Œå¼€å§‹è¯»å–åƒç´ 
                            if (width > 0 && height > 0 && maxVal !== 255) {
                                readingPixels = true;
                            }
                        }
                    } else {
                        // è¯»å–åƒç´ æ•°æ®
                        const values = line.split(/\s+/).filter(val => val !== '');
                        for (const val of values) {
                            pixelData.push(parseInt(val));
                        }
                    }
                }
                
                // éªŒè¯æ•°æ®
                if (width <= 0 || height <= 0) {
                    throw new Error("æ— æ•ˆçš„PGMå¤´éƒ¨: ç¼ºå°‘å®½åº¦æˆ–é«˜åº¦");
                }
                
                if (pixelData.length !== width * height) {
                    throw new Error(`åƒç´ æ•°æ®ä¸åŒ¹é…: æœŸæœ› ${width * height} ä¸ªå€¼ï¼Œå¾—åˆ° ${pixelData.length}`);
                }
                
                createImageFromPGM(pixelData, width, height, name, 'P2');
            } catch (error) {
                showError("è§£æP2æ ¼å¼å¤±è´¥: " + error.message);
                statusText.textContent = 'è§£æå¤±è´¥';
            }
        }
        
        // è§£æP5æ ¼å¼(PGMäºŒè¿›åˆ¶)
        function parseP5Format(data, name) {
            try {
                const buffer = data instanceof ArrayBuffer ? data : data.buffer;
                const view = new DataView(buffer);
                let offset = 0;
                
                // æ£€æŸ¥é­”æœ¯å­— "P5"
                if (view.getUint8(offset) !== 80 || view.getUint8(offset+1) !== 53) {
                    throw new Error("æ— æ•ˆçš„P5æ ¼å¼: é­”æœ¯å­—åº”ä¸ºP5");
                }
                offset += 2;
                
                // è·³è¿‡æ³¨é‡Šå’Œç©ºç™½
                while (offset < buffer.byteLength) {
                    const byte = view.getUint8(offset);
                    if (byte === 35) { // '#' æ³¨é‡Šå¼€å§‹
                        while (offset < buffer.byteLength && view.getUint8(offset) !== 10) {
                            offset++;
                        }
                    } else if (byte === 10 || byte === 13 || byte === 9 || byte === 32) {
                        offset++; // è·³è¿‡ç©ºç™½
                    } else {
                        break; // æ‰¾åˆ°éç©ºç™½å­—ç¬¦
                    }
                }
                
                // è¯»å–å®½åº¦
                let width = '';
                while (offset < buffer.byteLength) {
                    const byte = view.getUint8(offset);
                    if (byte === 32 || byte === 10 || byte === 13) break;
                    width += String.fromCharCode(byte);
                    offset++;
                }
                offset++; // è·³è¿‡åˆ†éš”ç¬¦
                
                // è¯»å–é«˜åº¦
                let height = '';
                while (offset < buffer.byteLength) {
                    const byte = view.getUint8(offset);
                    if (byte === 32 || byte === 10 || byte === 13) break;
                    height += String.fromCharCode(byte);
                    offset++;
                }
                offset++; // è·³è¿‡åˆ†éš”ç¬¦
                
                // è¯»å–æœ€å¤§ç°åº¦å€¼
                let maxVal = '';
                while (offset < buffer.byteLength) {
                    const byte = view.getUint8(offset);
                    if (byte === 10 || byte === 13) break;
                    maxVal += String.fromCharCode(byte);
                    offset++;
                }
                offset++; // è·³è¿‡æ¢è¡Œç¬¦
                
                width = parseInt(width);
                height = parseInt(height);
                maxVal = parseInt(maxVal);
                
                if (isNaN(width) || isNaN(height) || isNaN(maxVal)) {
                    throw new Error("æ— æ•ˆçš„PGMå¤´éƒ¨: å®½åº¦ã€é«˜åº¦æˆ–æœ€å¤§å€¼æ— æ•ˆ");
                }
                
                if (maxVal > 255) {
                    throw new Error("ä¸æ”¯æŒçš„PGMæ ¼å¼: æœ€å¤§ç°åº¦å€¼å¤§äº255");
                }
                
                // è¯»å–åƒç´ æ•°æ®
                const pixelCount = width * height;
                const pixels = new Uint8Array(buffer, offset, pixelCount);
                
                // è½¬æ¢ä¸ºRGBæ•°ç»„
                const rgbData = [];
                for (let i = 0; i < pixelCount; i++) {
                    const gray = pixels[i];
                    rgbData.push(gray, gray, gray); // R, G, B
                }
                
                createImageFromPGM(rgbData, width, height, name, 'P5');
            } catch (error) {
                showError("è§£æP5æ ¼å¼å¤±è´¥: " + error.message);
                statusText.textContent = 'è§£æå¤±è´¥';
            }
        }
        
        // ä»PGMæ•°æ®åˆ›å»ºå›¾åƒ
        function createImageFromPGM(pixelData, width, height, name, format) {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(width, height);
                
                // å¡«å……åƒç´ æ•°æ®
                if (format === 'P2') {
                    // P2æ ¼å¼æ•°æ®æ˜¯ç°åº¦å€¼æ•°ç»„
                    for (let i = 0; i < pixelData.length; i++) {
                        const gray = pixelData[i];
                        const idx = i * 4;
                        imageData.data[idx] = gray;     // R
                        imageData.data[idx+1] = gray;   // G
                        imageData.data[idx+2] = gray;   // B
                        imageData.data[idx+3] = 255;     // A
                    }
                } else {
                    // P5æ ¼å¼æ•°æ®å·²ç»æ˜¯RGBæ•°ç»„
                    for (let i = 0; i < pixelData.length; i++) {
                        imageData.data[i] = pixelData[i];
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                // åˆ›å»ºå›¾åƒå¯¹è±¡
                const imgObj = new Image();
                imgObj.onload = function() {
                    handleImageLoad(imgObj, name, 'PGM');
                    showSuccess("PGMå›¾åƒåŠ è½½æˆåŠŸ: " + name);
                };
                imgObj.src = canvas.toDataURL('image/png');
            } catch (error) {
                showError("åˆ›å»ºå›¾åƒå¤±è´¥: " + error.message);
                statusText.textContent = 'åˆ›å»ºå¤±è´¥';
            }
        }
        
        // å¤„ç†å›¾åƒåŠ è½½å®Œæˆ
        function handleImageLoad(image, name, type) {
            img = image;
            imgWidth = img.width;
            imgHeight = img.height;
            sizeValue.textContent = `${imgWidth} Ã— ${imgHeight}`;
            formatValue.textContent = type || getFormatFromName(name);
            
            // åˆå§‹ç¼©æ”¾ä»¥é€‚åº”ç”»å¸ƒ
            const scaleX = mainCanvas.width / imgWidth;
            const scaleY = mainCanvas.height / imgHeight;
            scale = Math.min(scaleX, scaleY) * 0.9;
            offsetX = (mainCanvas.width - imgWidth * scale) / 2;
            offsetY = (mainCanvas.height - imgHeight * scale) / 2;
            
            updateZoomDisplay();
            drawImage();
            drawGrid();
            statusText.textContent = 'å°±ç»ª';
        }
        
        // ä»æ–‡ä»¶åè·å–æ ¼å¼
        function getFormatFromName(name) {
            if (!name) return 'æœªçŸ¥';
            const ext = name.split('.').pop().toUpperCase();
            return ext || 'æœªçŸ¥';
        }
        
        // æ›´æ–°ç¼©æ”¾æ˜¾ç¤º
        function updateZoomDisplay() {
            const zoomPercent = Math.round(scale * 100);
            zoomValue.textContent = `${zoomPercent}%`;
            zoomIndicator.textContent = `${zoomPercent}%`;
        }
        
        // è·å–é¼ æ ‡åœ¨å›¾åƒä¸Šçš„ä½ç½®
        function getImagePosition(clientX, clientY) {
            const rect = mainCanvas.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            // è½¬æ¢ä¸ºå›¾åƒåæ ‡
            const imgX = Math.floor((x - offsetX) / scale);
            const imgY = Math.floor((y - offsetY) / scale);
            
            return { 
                x: imgX, 
                y: imgY, 
                inImage: imgX >= 0 && imgX < imgWidth && imgY >= 0 && imgY < imgHeight,
                screenX: x,
                screenY: y
            };
        }
        
        // è·å–åƒç´ é¢œè‰²
        function getPixelColor(x, y) {
            if (!img || x < 0 || x >= imgWidth || y < 0 || y >= imgHeight) {
                return [0, 0, 0];
            }
            
            // åˆ›å»ºä¸´æ—¶canvasè·å–åƒç´ æ•°æ®
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = imgWidth;
            tempCanvas.height = imgHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(img, 0, 0);
            
            const pixelData = tempCtx.getImageData(x, y, 1, 1).data;
            return [pixelData[0], pixelData[1], pixelData[2]];
        }
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }
        
        // éšè—æ¶ˆæ¯
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
        
        // ç”ŸæˆPGMç¤ºä¾‹æ–‡ä»¶
        function generatePGMSample() {
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„5x5 PGMå›¾åƒ
            const width = 5;
            const height = 5;
            const maxVal = 255;
            
            // åˆ›å»ºP2æ ¼å¼å†…å®¹
            let content = "P2\n";
            content += `# 5x5 PGM Sample\n`;
            content += `${width} ${height}\n`;
            content += `${maxVal}\n`;
            
            // æ·»åŠ åƒç´ æ•°æ®
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    // åˆ›å»ºæ¸å˜æ•ˆæœ
                    const value = Math.floor(255 * (x + y) / (width + height - 2));
                    content += value + " ";
                }
                content += "\n";
            }
            
            return content;
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        uploadBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const fileName = file.name.toLowerCase();
                const fileExt = fileName.split('.').pop();
                
                hideMessages();
                
                if (['bmp', 'jpg', 'jpeg', 'png', 'pgm', 'gif', 'webp', 'tiff'].includes(fileExt)) {
                    if (fileExt === 'pgm') {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            loadPGMImage(event.target.result, file.name);
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            loadImage(event.target.result, file.name, fileExt);
                        };
                        reader.readAsDataURL(file);
                    }
                } else {
                    showError("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: " + fileExt);
                }
            }
        });
        
        sampleBtn.addEventListener('click', () => {
            // ä½¿ç”¨å†…ç½®çš„ç¤ºä¾‹å›¾åƒ
            const formats = ['jpg', 'png', 'bmp'];
            const randomFormat = formats[Math.floor(Math.random() * formats.length)];
            loadImage(`https://picsum.photos/800/600?random=${Math.floor(Math.random()*1000)}`, `sample.${randomFormat}`, randomFormat);
        });
        
        pgmSampleBtn.addEventListener('click', () => {
            // ç”Ÿæˆå¹¶ä¸‹è½½PGMç¤ºä¾‹æ–‡ä»¶
            const content = generatePGMSample();
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample.pgm';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess("ç¤ºä¾‹PGMæ–‡ä»¶å·²ä¸‹è½½: sample.pgm (5x5 P2æ ¼å¼)");
        });
        
        downloadSample.addEventListener('click', (e) => {
            e.preventDefault();
            pgmSampleBtn.click();
        });
        
        zoomInBtn.addEventListener('click', () => {
            if (scale < 16) { // æœ€å¤§1600%
                scale *= 1.2;
                updateZoomDisplay();
                drawImage();
                drawGrid();
            }
        });
        
        zoomOutBtn.addEventListener('click', () => {
            if (scale > 0.1) { // æœ€å°10%
                scale /= 1.2;
                updateZoomDisplay();
                drawImage();
                drawGrid();
            }
        });
        
        resetViewBtn.addEventListener('click', () => {
            if (img) {
                scale = 1.0;
                offsetX = 0;
                offsetY = 0;
                updateZoomDisplay();
                drawImage();
                drawGrid();
            }
        });
        
        toggleGridBtn.addEventListener('click', () => {
            showGrid = !showGrid;
            toggleGridBtn.innerHTML = showGrid ? '<span>ç½‘æ ¼: å¼€</span>' : '<span>ç½‘æ ¼: å…³</span>';
            gridStatus.textContent = showGrid ? 'å¼€å¯' : 'å…³é—­';
            drawGrid();
        });
        
        // é¼ æ ‡äº‹ä»¶
        mainCanvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
            mainCanvas.style.cursor = 'grabbing';
        });
        
        mainCanvas.addEventListener('mousemove', (e) => {
            // æ‹–åŠ¨å¤„ç†
            if (isDragging) {
                offsetX += e.clientX - lastX;
                offsetY += e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
                drawImage();
                drawGrid();
                return;
            }
            
            // åƒç´ ä¿¡æ¯æ˜¾ç¤º
            if (img) {
                const pos = getImagePosition(e.clientX, e.clientY);
                coordValue.textContent = `(${pos.x}, ${pos.y})`;
                
                if (pos.inImage) {
                    const [r, g, b] = getPixelColor(pos.x, pos.y);
                    rgbValue.textContent = `(${r}, ${g}, ${b})`;
                    rgbValue.style.color = `rgb(${r}, ${g}, ${b})`;
                    colorPreview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    
                    // è®¡ç®—åƒç´ åœ¨å±å¹•ä¸Šçš„å¤§å°
                    const pixelScreenSize = Math.max(1, Math.round(scale));
                    pixelSizeValue.textContent = `${pixelScreenSize}Ã—${pixelScreenSize} px`;
                } else {
                    rgbValue.textContent = '(0, 0, 0)';
                    rgbValue.style.color = '#3498db';
                    colorPreview.style.backgroundColor = '#000';
                    pixelSizeValue.textContent = '0Ã—0 px';
                }
            }
        });
        
        mainCanvas.addEventListener('mouseup', () => {
            isDragging = false;
            mainCanvas.style.cursor = 'crosshair';
        });
        
        mainCanvas.addEventListener('mouseleave', () => {
            isDragging = false;
            mainCanvas.style.cursor = 'default';
        });
        
        // æ»šè½®ç¼©æ”¾
        mainCanvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const zoomFactor = Math.exp(wheel * zoomIntensity);
            const newScale = scale * zoomFactor;
            
            // é™åˆ¶ç¼©æ”¾èŒƒå›´
            if (newScale < 0.1 || newScale > 16) return;
            
            // è®¡ç®—ç¼©æ”¾å‰åçš„åæ ‡
            const rect = mainCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const imgPosBefore = {
                x: (mouseX - offsetX) / scale,
                y: (mouseY - offsetY) / scale
            };
            
            // åº”ç”¨ç¼©æ”¾
            scale = newScale;
            updateZoomDisplay();
            
            // è°ƒæ•´åç§»é‡ä»¥ä¿æŒé¼ æ ‡ä½ç½®ä¸å˜
            offsetX = mouseX - imgPosBefore.x * scale;
            offsetY = mouseY - imgPosBefore.y * scale;
            
            drawImage();
            drawGrid();
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === '+') {
                if (scale < 16) {
                    scale *= 1.2;
                    updateZoomDisplay();
                    drawImage();
                    drawGrid();
                }
            } else if (e.key === '-') {
                if (scale > 0.1) {
                    scale /= 1.2;
                    updateZoomDisplay();
                    drawImage();
                    drawGrid();
                }
            } else if (e.key === '0') {
                if (img) {
                    scale = 1.0;
                    offsetX = 0;
                    offsetY = 0;
                    updateZoomDisplay();
                    drawImage();
                    drawGrid();
                }
            } else if (e.key.toLowerCase() === 'g') {
                showGrid = !showGrid;
                toggleGridBtn.innerHTML = showGrid ? '<span>ç½‘æ ¼: å¼€</span>' : '<span>ç½‘æ ¼: å…³</span>';
                gridStatus.textContent = showGrid ? 'å¼€å¯' : 'å…³é—­';
                drawGrid();
            }
        });
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initCanvas();
            // åŠ è½½ç¤ºä¾‹å›¾åƒ
            setTimeout(() => {
                if (!img) {
                    loadImage('https://picsum.photos/800/600?random=1', 'sample.jpg', 'jpg');
                }
            }, 1000);
        });
        
        window.addEventListener('resize', () => {
            initCanvas();
        });
    </script>
</body>
</html>